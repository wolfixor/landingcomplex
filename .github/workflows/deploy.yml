name: Build and Deploy landing

on:
  push:
    branches: [main, staging, dev, 'release/*']
  pull_request:
    branches: [main, staging, dev, 'release/*']

permissions:
  contents: read
  security-events: write
  actions: read

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: wolfix1245/landing

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci

    - name: Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        npm test
        npm run lint

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [validate, test]
    environment: 
      name: ${{ github.ref_name == 'main' && 'production' || (github.ref_name == 'staging' && 'staging' || 'development') }}
    env:
      ENV: ${{ github.ref_name == 'main' && 'prod' || (github.ref_name == 'staging' && 'staging' || 'dev') }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: |
          ${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.IMAGE_NAME }}:${{ env.ENV }}-latest

    - name: Push Docker image
      if: success()
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.IMAGE_NAME }}:${{ env.ENV }}-latest

    - name: Trigger GitOps Repository Update
      if: github.event_name == 'push' && success()
      run: |
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITOPS_TOKEN }}" \
          https://api.github.com/repos/wolfixor/gitops-repo/dispatches \
          -d "{
            \"event_type\": \"update-manifest\",
            \"client_payload\": {
              \"app_name\": \"landing\",
              \"image_tag\": \"${{ github.sha }}\",
              \"environment\": \"${{ env.ENV }}\"
            }
          }"
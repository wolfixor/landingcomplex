name: Build and Deploy landing

on:
  push:
    branches: [main, staging, dev, 'release/*']
  pull_request:
    branches: [main, staging, dev, 'release/*']

permissions:
  contents: read
  security-events: write
  actions: read

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: wolfix1245/landing

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci

    - name: Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        npm test
        npm run lint

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [validate, test]
    environment: 
      name: ${{ github.ref_name == 'main' && 'production' || (github.ref_name == 'staging' && 'staging' || 'development') }}
    env:
      ENV: ${{ github.ref_name == 'main' && 'prod' || (github.ref_name == 'staging' && 'staging' || 'dev') }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: |
          ${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.IMAGE_NAME }}:${{ env.ENV }}-latest

    - name: Push Docker image
      if: success()
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.IMAGE_NAME }}:${{ env.ENV }}-latest

    - name: Update GitOps Repository
      if: github.event_name == 'push' && success()
      run: |
        git clone https://${{ secrets.GITOPS_TOKEN }}@github.com/wolfixor/gitops-repo.git
        cd gitops-repo
        
        # Update image tag based on environment
        case "${{ env.ENV }}" in
          prod)
            sed -i "s|newTag: \".*\"|newTag: \"${{ github.sha }}\"|g" \
              apps/landing/overlays/prod/kustomization.yaml
            ;;
          staging)
            sed -i "s|newTag: \".*\"|newTag: \"${{ github.sha }}\"|g" \
              apps/landing/overlays/staging/kustomization.yaml
            ;;
          dev)
            sed -i "s|newTag: \".*\"|newTag: \"${{ github.sha }}\"|g" \
              apps/landing/overlays/dev/kustomization.yaml
            ;;
        esac
        
        # Commit and push changes
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "ðŸš€ Update landing image to ${{ github.sha }} for ${{ env.ENV }}"
        git push origin main